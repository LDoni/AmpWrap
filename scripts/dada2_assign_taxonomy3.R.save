#!/usr/bin/env Rscript

args <- commandArgs(trailingOnly = TRUE)
input <- args[1]
silva_db <- args[2]
output_dir <- args[3]
species<-args[4]

suppressPackageStartupMessages(library(dada2))

# Carica dati senza chimere
seqtab_nochim <- readRDS(input)

# Assegna la tassonomia
taxa <- assignTaxonomy(seqtab_nochim, silva_db, multithread = TRUE)
if species 
taxa <- addSpecies(taxa, "~/tax/silva_species_assignment_v132.fa.gz")

# Salva risultati
asv_seqs <- colnames(seqtab_nochim)
#asv_headers <- paste0(">ASV_", seq_len(ncol(seqtab_nochim)))

asv_headers <- vector(dim(seqtab.nochim)[2], mode = "character")
for (i in seq_along(asv_seqs)) {
  asv_headers[i] <- paste(">ASV", i, sep = "_")
}

# Salva ASVs
write(c(rbind(asv_headers, asv_seqs)), file.path(output_dir, "ASVs.fa"))







# Salva conteggio ASVs

asv_tab <- t(seqtab.nochim)
row.names(asv_tab) <- sub(">", "", asv_headers)
write.csv(asv_tab, file.path(output_dir, "ASVs_counts.csv"), row.names = TRUE, quote = FALSE)





# Salva tassonomia

ranks <- c("domain", "phylum", "class", "order", "family", "genus", "species")
asv_tax <- t(sapply(taxa, function(x) {
  m <- match(ranks, x$rank)
  taxaa <- x$taxon[m]
  taxaa[startsWith(taxaa, "unclassified_")] <- NA
  taxaa
}))
colnames(asv_tax) <- ranks
rownames(asv_tax) <- gsub(pattern = ">", replacement = "", x = asv_headers)

write.csv(asv_tax, file.path(output_dir, "ASVs_taxonomy.csv"), row.names = TRUE, quote = FALSE)
